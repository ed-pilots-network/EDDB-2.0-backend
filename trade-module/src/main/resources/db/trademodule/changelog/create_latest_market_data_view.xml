<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="latest_market_data_view" author="pveeckhout" runOnChange="true">
        <createView viewName="latest_market_data_view" replaceIfExists="true">
            <![CDATA[
            SELECT
                md1.station_id,
                md1.commodity_id,
                md1.mean_price,
                md1.buy_price,
                md1.stock,
                md1.stock_bracket,
                md1.sell_price,
                md1.demand,
                md1.demand_bracket,
                md1.status_flags,
                md1.prohibited,
                md1.timestamp
            FROM market_datum md1
            INNER JOIN validated_commodity_view vcv ON vcv.id = md1.commodity_id
            INNER JOIN (
              SELECT station_id, MAX(timestamp) AS latest_timestamp
              FROM market_datum
              GROUP BY station_id
            ) md2 ON md1.station_id = md2.station_id AND md1.timestamp = md2.latest_timestamp;
            ]]>
        </createView>
    </changeSet>

</databaseChangeLog>
